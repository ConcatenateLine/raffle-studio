name: Deploy dist from source
on:
  repository_dispatch:
    types: [deploy_dist]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Configure bot identity
        run: |
          git config user.name "ConcatenateLine[bot]"
          git config user.email "bot@concatenateline.dev"

      - name: Download artifact from source run
        env:
          OWNER: ${{ github.event.client_payload.source_owner }}
          REPO: ${{ github.event.client_payload.source_repo }}
          RUN_ID: ${{ github.event.client_payload.run_id }}
          GH_TOKEN: ${{ secrets.SOURCE_READ_TOKEN }} # fine-grained PAT with Actions: read on source repo
        run: |
          set -e  # Exit immediately if any command fails
          
          # Initial cleanup
          echo "üîÑ Starting artifact deployment at $(date)"
          rm -f artifact.zip
          
          # Ensure dist directory exists
          mkdir -p dist
          
          # 1) Fetch artifact metadata
          echo "üîç Fetching artifacts for run $RUN_ID..."
          ARTIFACT_URL="https://api.github.com/repos/$OWNER/${REPO#*/}/actions/runs/$RUN_ID/artifacts"
          
          # Add retry logic for API request
          MAX_RETRIES=3
          RETRY_DELAY=5
          for i in $(seq 1 $MAX_RETRIES); do
            if RESPONSE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$ARTIFACT_URL"); then
              break
            fi
            if [ $i -eq $MAX_RETRIES ]; then
              echo "‚ùå Failed to fetch artifacts after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "‚ö†Ô∏è Attempt $i failed, retrying in $RETRY_DELAY seconds..."
            sleep $RETRY_DELAY
          done

          # Extract artifact ID with better error handling
          ARTIFACT_ID=$(echo "$RESPONSE" | jq -r '.artifacts[] | select(.name=="dist") | .id')
          if [ -z "$ARTIFACT_ID" ]; then 
            echo "‚ùå Artifact 'dist' not found in run $RUN_ID"
            echo "Available artifacts:"
            echo "$RESPONSE" | jq '.artifacts[].name'
            exit 1
          fi

          # 2) Download artifact
          echo "üì• Downloading artifact $ARTIFACT_ID..."
          DOWNLOAD_URL="https://api.github.com/repos/$OWNER/${REPO#*/}/actions/artifacts/$ARTIFACT_ID/zip"
          
          if ! curl -L -f -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
              -o artifact.zip "$DOWNLOAD_URL"; then
            echo "‚ùå Failed to download artifact"
            exit 1
          fi

          # Verify download size
          FILESIZE=$(stat -c%s "artifact.zip")
          if [ "$FILESIZE" -lt 100 ]; then
            echo "‚ùå Downloaded file is too small (${FILESIZE} bytes), likely an error"
            rm -f artifact.zip
            exit 1
          fi

          # 3) Clean and extract
          echo "üßπ Cleaning destination directory..."
          rm -rf dist/*
          
          echo "üì¶ Extracting artifact..."
          if ! unzip -q artifact.zip -d dist; then
            echo "‚ùå Failed to extract artifact"
            rm -rf dist/*
            rm -f artifact.zip
            exit 1
          fi

          # Verify extraction
          if [ -z "$(ls -A dist)" ]; then
            echo "‚ùå Extraction completed but dist directory is empty"
            rm -rf dist/*
            rm -f artifact.zip
            exit 1
          fi

          # Cleanup and finalize
          rm -f artifact.zip
          echo "‚úÖ Success! Artifact downloaded and extracted to dist/"
          echo "   Extracted files:"
          find dist -type f | sed 's/^/   - /'

      - name: Commit and push
        run: |
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          git checkout -B "$DEFAULT_BRANCH"
          git add .
          git commit -m "Deploy dist from ${{ github.event.client_payload.source_repo }} run ${{ github.event.client_payload.run_id }}" || echo "No changes to commit"
          git push origin HEAD:"$DEFAULT_BRANCH"

      - name: Dispatch static deploy
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${OWNER}/${REPO}/dispatches \
            -d '{"event_type":"deploy_static"}'

