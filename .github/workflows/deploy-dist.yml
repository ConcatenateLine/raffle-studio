name: Deploy dist from source
on:
  repository_dispatch:
    types: [deploy_dist]

permissions:
  contents: write
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Configure bot identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Download artifact from source run
        env:
          OWNER: ${{ github.event.client_payload.source_owner }}
          REPO: ${{ github.event.client_payload.source_repo }}
          RUN_ID: ${{ github.event.client_payload.run_id }}
          GH_TOKEN: ${{ secrets.SOURCE_READ_TOKEN }} # fine-grained PAT with Actions: read on source repo
        run: |
          if [ ! -d "dist" ]; then
            mkdir dist
          fi
          # Download artifact using the API
          # 1) List artifacts for the run
          ARTIFACT_URL="https://api.github.com/repos/$OWNER/${REPO#*/}/actions/runs/$RUN_ID/artifacts"
          ARTIFACT_ID=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$ARTIFACT_URL" | jq -r '.artifacts[] | select(.name=="dist") | .id')
          if [ -z "$ARTIFACT_ID" ]; then echo "Artifact 'dist' not found"; exit 1; fi

          # 2) Download the artifact archive
          DOWNLOAD_URL="https://api.github.com/repos/$OWNER/${REPO#*/}/actions/artifacts/$ARTIFACT_ID/zip"
          curl -L -s -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" "$DOWNLOAD_URL" -o artifact.zip

          # 3) Extract into dist/
          unzip -q artifact.zip -d dist

      - name: Sync dist into repo
        run: |
          rsync -av --delete ./dist/ ./dist/

      - name: Commit and push
        run: |
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          git checkout -B "$DEFAULT_BRANCH"
          git add .
          git commit -m "Deploy dist from ${{ github.event.client_payload.source_repo }} run ${{ github.event.client_payload.run_id }}" || echo "No changes to commit"
          git push origin HEAD:"$DEFAULT_BRANCH"

